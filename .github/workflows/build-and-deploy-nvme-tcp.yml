name: Build and Deploy NVMe-TCP Kernel Module

on:
  push:
    branches: [main, feat/*]
  workflow_dispatch:
    inputs:
      version:
        description: "Kernel module version"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version || 'stable-4230.2.2' }}

    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run docker-nvme-tcp.sh
        if: github.ref == 'refs/heads/main'
        run: |
          chmod +x build/kernel/nvme/docker-nvme-tcp.sh
          ./build/kernel/nvme/docker-nvme-tcp.sh

      - name: Find built nvme-tcp.ko.xz
        id: find_nvme
        run: |
          find . -name nvme-tcp.ko.xz > nvme-tcp-path.txt
          NVME_PATH=$(head -n 1 nvme-tcp-path.txt)
          echo "nvme_path=$NVME_PATH" >> $GITHUB_OUTPUT

      - name: Get git revision information
        id: git_revision
        run: |
          GIT_REVISION=$(date +"%Y%m%d")-$(git rev-parse --short HEAD)
          echo "git_revision=$GIT_REVISION" >> $GITHUB_OUTPUT

      - name: Upload nvme-tcp.ko.xz as artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: nvme-tcp-ko-xz-${{ steps.git_revision.outputs.git_revision }}
          path: ${{ steps.find_nvme.outputs.nvme_path }}

      - name: Create release and upload package with commit hash
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nvme-tcp-amd64-${{ env.VERSION }}-${{ steps.git_revision.outputs.git_revision }}
          name: NVMe-TCP Kernel Module ${{ env.VERSION }}-${{ steps.git_revision.outputs.git_revision }}
          files: ${{ steps.find_nvme.outputs.nvme_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release and upload package with version tag
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nvme-tcp-amd64-${{ env.VERSION }}
          name: NVMe-TCP Kernel Module ${{ env.VERSION }}
          files: ${{ steps.find_nvme.outputs.nvme_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
